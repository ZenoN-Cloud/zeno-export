stages:
  - lint
  - test
  - build

variables:
  GO_VERSION: "1.25"

# Lint stage
go-fmt:
  stage: lint
  image: golang:${GO_VERSION}-alpine
  script:
    - gofmt -l . | tee /tmp/fmt-output
    - test ! -s /tmp/fmt-output
  only:
    - merge_requests
    - main
    - develop

golangci-lint:
  stage: lint
  image: golangci/golangci-lint:v1.60-alpine
  script:
    - golangci-lint run -v --timeout 5m || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Test stage
unit-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  variables:
    CGO_ENABLED: "0"
  before_script:
    - apk add --no-cache git make
    - go mod download
  script:
    - go test -short -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage.out
    when: always
  only:
    - merge_requests
    - main
    - develop

integration-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  variables:
    CGO_ENABLED: "0"
  before_script:
    - apk add --no-cache git make
    - go mod download
  script:
    - go test -v ./export/... -tags=integration
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Build stage
build-wasm:
  stage: build
  image: golang:${GO_VERSION}-alpine
  variables:
    GOOS: "js"
    GOARCH: "wasm"
    CGO_ENABLED: "0"
  before_script:
    - apk add --no-cache git make
    - go mod download
  script:
    - go build -o export.wasm ./cmd/wasm-export
    - ls -lh export.wasm
  artifacts:
    paths:
      - export.wasm
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop


